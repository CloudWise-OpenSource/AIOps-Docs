# 基于自动阈值的异常检测

# 1. 认识自动阈值算法

## 1.1 简介

异常检测用来检测异于正常模式的对象。

自动阈值算法根据极值理论构建数据极值的概率分布模型。通过检验一个（多个）对象是否服从该分布来判断异常。如果不服从，则认为该对象是一个异常。

## 1.2 算法描述

- 自动阈值（automatic thresholding）算法原理

通常情况下，某个数据（指标）的分布会符合某一分布，我们将该分布中极端值的分布情况描述为分布的“尾”。在数据（指标）分布未知的情况下，使用任意常见分布，构建分数分布时，都容易产生偏差。对于任意分布的数据（指标），均可以用极值分布来描述数据的“尾”分布。

- 分段自动阈值算法原理

分段自动阈值是自动阈值算法的衍生，用于适配部分自动阈值算法不适合处理的场景。如图1所示的场景，数据模式周期性呈现。自动阈值算法会将数据作为一个整体来构建极值分布，会生成单个阈值来划分异常点，无法精确的定为到图1中标示的异常点（红点）。分段自动阈值通过对数据分段来解决这一缺陷。通过将数据按时刻分段，对同一时刻段对数据建立极值分布并生成针对该数据段的阈值，以此生成适配不同时刻数据的阈值。

![](/images/6h5RdnhBLowFp1LkrSJm8v.png)

图1

缺陷：分段自动阈值要求数据有严格的周期型。

# 2. 算法原理

## 2.1 数据预处理

![1](/images/eAoiEbXbDSmBFaGgF8kdgq.jpeg)

## 2.2. 模型建立

通过对数据进行极值分布的拟合，可对数据分布进行建模。实际计算过程中，由于极值分布的拟合计算比较困难，采用 PeaksOver-Threshold 来拟合数据的“尾”的分布。

![97C2399811656C1FFF48E63EB0A49D51](/images/8Gkir7JyQSguiddFS8mqFN.jpeg)

数据拟合流程如下：

![2](/images/fsjPHiu8wPXksyiYdmuMD.jpeg)

# 3. 算法功能

功能一：基于历史数据，对未来一段时间内数据进行异常检测。

当数据中不存在周期、季节性模式变化、持续时间较长的趋势变化以及突增突降变化的成分时，可以采用自动阈值算法；实践中多以响应时间、请求率类型指标相对比较适用自动阈值。

# 4. 应用场景

自动阈值算法主要应用于DOCP平台中的事件管理和指标体系工作台产品模块。

1. 在事件管理模块通过定期对历史指标数据的模型训练，自动计算出未来一段时间的指标上下阈值，在实时数据到达时，实时聚合出当前指标数值，与预测的上下阈值进行比较，超出阈值区间范围的判定为异常数据，根据具体配置的告警规则进行进一步判断或通知

2. 在指标体系工作台模块，针对选择自动阈值算法作为指标健康度计算的，同样定时选取历史数据进行模型训练，计算出未来一段时间的指标上下阈值和基准值。根据实际指标与基准值的偏离程度与上下阈值比较来评估指标健康度。

# 5. 使用操作

## 5.1. 输入数据说明

方法调用时，数据格式需要为Json形式，数据内容需包含时间、数据值。示例如下：

'[{"value": 69.91 , "timestamp": 1585670400000 },

{"value": 60.78 , "timestamp": 1585670700000 },

{"value": 61.70 , "timestamp": 1585671000000 },

{"value": 69.82 , "timestamp": 1585671300000 },

{"value": 63.39 , "timestamp": 1585671600000 },

{"value": 67.79 , "timestamp": 1585671900000 },

{"value": 66.53 , "timestamp": 1587168900000 },

{"value": 65.72 , "timestamp": 1587169200000 },

{"value": 65.54 , "timestamp": 1587169500000 },

{"value": 65.82 , "timestamp": 1587169800000 },

{"value": 61.98 , "timestamp": 1587170100000 }]'

## 5.2. 输出文件说明

输出文件示例：

{

"up": 3905.9479543793573, 

"down": 22.076544957429228, 

"yhat": 52.23315, 

"anomaly":[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...... , 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],

"_up": **true** , 

"_down": **null** 

}

说明：

up：上边界

down：下边界

yhat：基线的幅度大小

anomaly：0正常点，1异常点

_up: True表示单边检测，anomaly中的异常点为大于上边界的点

_down：True表示单边检测，anomaly中的异常点为小于下边界的点

# 6. 算法使用方案

|方案：|实时训练|非实时训练|异常点适应|异常点不适应|
|---|---|---|---|---|
|简介|每产生一个数据点就重新训练一次，更新分布|新数据产生时不更新分布模型|异常点参与训练|异常点不参与训练|
|优点|及时适应数据新变化|无法及时适应数据变换，误报率高|能够适应异常，后续检测边界会受异常点影响|不会适应异常，后续检测边界不会受异常点影响|
|缺点|计算量大|计算量低| | |



# 7. 结果展示

测试结果 1：自动阈值（非实时训练）

![](/images/oFx1Eer6AnG392Qzg269QD.png)

测试结果 2：自动阈值（实时训练）

![](/images/jibNMA39z3rWHZYGqnBt2U.png)

测试结果 3：分段自动阈值

![](/images/5PsEj38ESpYK9CG4DrW8sg.png)

